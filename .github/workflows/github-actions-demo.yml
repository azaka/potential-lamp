name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions üöÄ
on:
  schedule:
    - cron: "0 0 * * *"
  push:
jobs:
  Explore-GitHub-Actions:
    timeout-minutes: 1440
    runs-on: ubuntu-latest
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 4598
          swap-size-mb: 1024
          remove-dotnet: 'true'
      - name: Check out repository code
        uses: actions/checkout@v4
      - run: |
          git clone https://github.com/JustEnoughLinuxOS/distribution -b dev
          cd distribution && git checkout bf90f7af16390830df298552c3eb621d3bb79f01
      - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "üñ•Ô∏è The workflow is now ready to test your code on the runner."
      - name: Cache 64 bit
        id: ccache-aarch64
        uses: actions/cache@v4
        with:
          path: distribution/.ccache-aarch64
          key: ${{ runner.os }}-ccache-aarch64-new
      - name: Cache 32 bit
        id: ccache-arm
        uses: actions/cache@v4
        with:
          path: distribution/.ccache-arm
          key: ${{ runner.os }}-ccache-arm-new
      - name: List files in the repository
        run: |
          cd $RUNNER_WORKSPACE/potential-lamp
          wget https://github.com/curl/curl/releases/download/curl-7_80_0/curl-7.80.0.tar.gz
          tar xf curl-7.80.0.tar.gz
          cd curl-7.80.0
          sudo apt install libmbedtls-dev -y
          ./configure --with-mbedtls
          make && sudo make install
          
          cd $RUNNER_WORKSPACE/potential-lamp/distribution
          cp ../package.mk packages/virtual/emulators/package.mk
          #no longer needed
          #git apply ../diff2
          cat packages/virtual/emulators/package.mk
          

          #cp projects/Rockchip/packages/u-boot/patches/RK3566/001-v3-add_additional_boards_and_features_to_rgxx3.patch projects/Rockchip/packages/u-boot/patches/RK3566-X55
          #cp projects/Rockchip/packages/u-boot/patches/RK3566/003-fix-dtb-and-vs.patch projects/Rockchip/packages/u-boot/patches/RK3566-X55
          #EMULATION_DEVICE=yes make docker-RK3566 docker-RK3566-X55

          git apply ../emudeviceno.patch
          EMULATION_DEVICE=no ENABLE_32BIT=no make docker-RK3566 docker-RK3566-X55
          #BASE_ONLY=true ENABLE_32BIT=no make docker-RK3566 docker-RK3566-X55
          ls -lah release
          df -h
          du . -h -d 1
          #2>&1 || true
          #CLEAN_PACKAGES="gmp" make docker-RK3566  
          cd $RUNNER_WORKSPACE/potential-lamp/distribution/release
          export LD_LIBRARY_PATH=/usr/local/lib
          curl -T JELOS-RK3566-X55.aarch64-*.img.gz https://pixeldrain.com/api/file/
          curl -T JELOS-RK3566-X55.aarch64-*.tar https://pixeldrain.com/api/file/
          
      - name: Save Cache 64 bit
        uses: actions/cache/save@v4
        id: save-ccache-aarch64
        with:
          path: distribution/.ccache-aarch64
          key: ${{ runner.os }}-ccache-aarch64-new
      - name: Save Cache 32 bit
        uses: actions/cache/save@v4
        id: save-ccache-arm
        with:
          path: distribution/.ccache-arm
          key: ${{ runner.os }}-ccache-arm-new
          
      - run: echo "üçè This job's status is ${{ job.status }}."
      - name: Setup upterm session
        uses: lhotari/action-upterm@v1
        if: ${{ failure() }}
        with:
          ## limits ssh access and adds the ssh public key for the user which triggered the workflow
          limit-access-to-actor: true
          ## If no one connects after 5 minutes, shut down server.
          wait-timeout-minutes: 60
